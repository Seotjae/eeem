<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
> 

<!-- 이 XML 이 어떤 interface 와 연결되는지 설정 -->
<mapper namespace="gudi.pro.eeem.dao.MeetDAO">
	<!-- 모임등록 -->
	<insert id="meetRegist" parameterType="meet"  useGeneratedKeys="true" keyProperty="meet_num" keyColumn="meet_num" >
		insert into meeting(mem_id,meet_subject,meet_phone,meet_content,meet_interest,meet_region,meet_gatherStart,meet_gatherEnd,meet_start,meet_end,meet_totalPrs,meet_point,meet_thum,meet_adState)
			values(#{mem_id},#{meet_subject},#{meet_phone},#{meet_content},#{meet_interest},#{meet_region},#{meet_gatherStart},#{meet_gatherEnd},#{meet_start},#{meet_end},#{meet_totalPrs},#{meet_point},#{meet_thum},#{meet_adState})
	</insert>
	
	<!-- 광고등록 -->
	<insert id="adRegist">
		insert into advertisement(meet_num,ad_meetArea) values(#{param1},#{param2})
	</insert>
	<!-- 광고비 알림 등록 -->
	<insert id="ntsRegist">
		insert into notice(mem_id,nts_targetNum,nts_content) values(#{param1},#{param2},#{param3})
	</insert>
	
	
	<!-- 사진등록 -->
	<insert id="registPhoto">
		insert into photo(meet_num,photo_oriName,photo_newName) values(#{param1},#{param2},#{param3})
	</insert>
	
	<!-- 스케쥴러 -->
	<update id="updateMeetState">
		update meeting set meet_state=#{param2} where meet_num=#{param1}
	</update>
	
	<select id="chkGthrSt" resultType="int">
		select meet_num from meeting m where m.meet_gatherStart <![CDATA[<=]]> #{param1} and m.meet_gatherEnd <![CDATA[>=]]> #{param1}
			and m.meet_state != 2 and meet_state != 1
	</select>
	
	<select id="chkGthrEd" resultType="int">
		select meet_num from meeting m where m.meet_gatherEnd <![CDATA[<=]]> #{param1} and m.meet_end <![CDATA[>=]]> #{param1} 
			and m.meet_state != 2 and meet_state !=3
	</select>
	
	<select id="chkEd" resultType="int">
		select meet_num from meeting m where date_add(m.meet_end, interval 3 day) <![CDATA[<=]]> #{param1}
			and m.meet_state != 2 and meet_state !=4
	</select>
	
	
	
	<!-- 모임리스트 관련 -->
	
	<select id="meetList" parameterType="gudi.pro.eeem.dto.PageDTO" resultType="gudi.pro.eeem.dto.MeetDTO">	
	select meet_region, meet_interest, meet_thum, meet_subject,meet_point,meet_start,meet_end from meeting 
	where 1=1
	
	<if test='meet_interest.size >= 1'>
		and meet_interest in
		<foreach collection="meet_interest" item="arr" open="(" close=")" separator=",">
			<if test="arr == 11">
			0,1,2,3,4,5,6
			</if>
			<if test="arr != 11">
			#{arr}
			</if>
		</foreach>
	</if>
	<if test='meet_region.size >= 1'>
		and meet_region in
		<foreach collection="meet_region" item="arr" open="(" close=")" separator=",">
			<if test="arr == 11">
			0,1,2,3,4,5,6,7
			</if>
			<if test="arr != 11">
			#{arr}
			</if>
		</foreach>
	</if>
	
	<if test='meet_point == 1'>
	  	and meet_point = 0
	</if>
	<if test='meet_point == 2'>
		and meet_point >0
	</if>
	<if test='keyword != null'>
	  	and meet_subject LIKE concat('%', #{keyword}, '%')
	</if>
	
	order by meet_date and meet_start desc 
	</select>
	
	<!--  
	<select id="meetSerchCount" parameterType="gudi.pro.eeem.dto.PageDTO" resultType="gudi.pro.eeem.dto.MeetDTO">
	select meet_thum, meet_subject,meet_point,meet_start,meet_end from meeting
	where 1=1
	
	<if test='meet_interest.size >= 1'>
		and meet_interest in
		<foreach collection="meet_interest" item="arr" open="(" close=")" separator=",">
			<if test="arr == 11">
			0,1,2,3,4,5,6
			</if>
			<if test="arr != 11">
			#{arr}
			</if>
		</foreach>
	</if>
	<if test='meet_region.size >= 1'>
		and meet_region in
		<foreach collection="meet_region" item="arr" open="(" close=")" separator=",">
			<if test="arr == 11">
			0,1,2,3,4,5,6,7
			</if>
			<if test="arr != 11">
			#{arr}
			</if>
		</foreach>
	</if>
	
	<if test='meet_point == 1'>
	  	and meet_point = 0
	</if>
	<if test='meet_point == 2'>
		and meet_point >0
	</if>
	<if test='keyword != null'>
	  	and meet_subject LIKE concat('%', #{keyword}, '%')
	</if>
	order by meet_date and meet_start desc limit #{displayPost}, #{postNum}
	</select>
	-->
	<!--  
	<select id="meetList" parameterType="gudi.pro.eeem.dto.PageDTO" resultType="gudi.pro.eeem.dto.MeetDTO">
      select meet_region, meet_interest, meet_thum, meet_subject,meet_point,meet_start,meet_end from meeting m 
      <where>
         <choose>
            <when test="meet_region.size > 1">
                  meet_region in 
                  <foreach collection="meet_region" item="region" separator="," open="(" close=")">
                  #{region}
                  </foreach>
               </when>
               <when test="meet_interest.size > 1">
                  meet_interest in 
                  <foreach collection="meet_interest" item="interest" separator="," open="(" close=")">
                  #{interest}
                  </foreach>
               </when>
               <when test="!keyword.equals('')">
                 meet_subject like concat('%',#{keyword},'%');
               </when>
               <when test="meet_point !=0">
                  <if test="meet_point == 1">
                     meet_point=0
                  </if>
                  <if test="meet_point == 2">
                     meet_point>0
                  </if>
               </when>
            </choose>
      </where>
   </select>
      -->


 
  <!-- 2022-03-15 유현진 모임 상세보기 -->
         <select id="meetDetail" resultType="gudi.pro.eeem.dto.MeetDTO">
    	 select m.meet_subject, m.meet_gatherStart, m.meet_gatherEnd, m.meet_start, m.meet_end, m.meet_content, m.meet_totalPrs,
		(select count(app_num) from applicant where meet_num =m.meet_num),
		m.meet_point, m.meet_region, m.meet_interest, m.meet_thum 
		from meeting m where meet_num = #{param1};
    </select>

   <!--2022-03-15 개설자 정보 가져오기 다오에서 이름을 meetDetailWriter 이걸로 가져올거야 가져오는건 해쉬맵으로-->
   <select id="MeetWriter" resultType="gudi.pro.eeem.dto.MeetWriterDTO">
	 select m.mem_id, m2.mem_phone ,m2.mem_email, m2.mem_name,
	(select avg(grd_score) from grade where grd_targetId = m.mem_id and grd_targetType = 1) as grd_score
		from meeting m left outer join members m2 on m.mem_id =m2.mem_id where m.meet_num = #{param1}
    </select>
    
       <!--2022-03-16 유현진 썸네일 불러오기  -->
    <select id="thumList" resultType="gudi.pro.eeem.dto.MeetDTO">
		select meet_thum from meeting where meet_num = #{param1}
   </select>
    
        <!-- 2022-03-16 유현진 모임 상세보기 승인인원 불러오기 -->
     <select id="approvechk" resultType="int">
		select count(app_num) from applicant where meet_num = #{param1} and app_state=1
   </select>
   
   		<!--2022-03-16 유현진 내 포인트 확인 -->
	     <select id="mpointchk" resultType="int">
	     <!-- 포인트에 등록된 사람이 없어서 csj1017 임시아이디 -->
			select sum(pt_count) from point where mem_id = 'csj1017'
   </select>
   
      <!--2022-03-17 유현진-모임신청 클릭시 신청자 테이블에 등록하는 기능 -->
<insert id="meetAppInsert" parameterType="hashmap">
 		insert into applicant(mem_id,meet_num) values(#{mem_id},#{meet_num})
 	</insert>
 	
 	
 	<!-- 2022-03-17 유현진-모임 신청시 알림테이블에 등록 -->
   <insert id="meetNoticeInsert" parameterType="hashmap">
 	insert into notice (mem_id, nts_content, nts_targetNum) values(#{mem_id},0,#{meet_num});
 	</insert>
   
   
   
   
	<!-- ========================개설한 모임 페이징================================================= -->
	<!-- 전체목록수 -->
	<select id="makeAllCount" resultType="int">
		SELECT COUNT(meet_num) FROM meeting WHERE mem_id= #{mem_id}
	</select>
	<!-- 글목록 -->
	<select id="MakeList" resultType="appNmeet">
		select m.meet_subject, m.meet_start, m.meet_end, m.meet_region, m.meet_totalPrs, m.meet_state, m.meet_thum, 
		m.meet_thum, m.meet_num, m.mem_id,
		(select count(a.app_num) from applicant a where a.meet_num=m.meet_num and a.app_state=1) as app_prs,
		(select count(a.app_num) from applicant a where a.meet_num=m.meet_num and a.app_confirm=1) as app_chkprs,
		(select count(g.mem_id) from grade g where g.grd_targetId = #{param3}) as grd_chk
		from meeting m where mem_id= #{param3}
		ORDER BY m.meet_num DESC
		LIMIT #{param1} OFFSET #{param2}
	</select>
<!--  meet_subject, meet_region, meet_totalPrs, app_state, meet_thum, meet_start, meet_end, meet_state, app_stateOne -->


	<!-- 신청한 모임 전체목록수 -->
	<select id="appAllCount" resultType="int">
		SELECT COUNT(app_num) FROM applicant WHERE mem_id= #{mem_id}
	</select>
	<!-- 신청한 모임목록 -->
	<select id="appList" resultType="myPageJoin">
		select a.app_num,m.meet_subject,m.meet_region,m.meet_totalPrs,a.app_state,m.meet_thum,
		m.meet_start,m.meet_end,m.meet_state,m.meet_num,
		(select count(a2.app_num) from applicant a2
		where a2.meet_num = m.meet_num and a2.app_state=1) as app_stateOne from
		applicant a left outer join meeting m on a.meet_num = m.meet_num where a.mem_id = #{param3}
		ORDER BY a.app_num DESC
>>>>>>> 1b48463946b2bd10ff52853c2d5d400e6221af29
		LIMIT #{param1} OFFSET #{param2}
	</select>
	
	
	<!--============== 모임 신청자 목록 페이징 ====================================================== -->
	<!-- 리스트수 -->
	<select id="meetAppAllCount" resultType="int">
		SELECT COUNT(app_num) FROM applicant WHERE meet_num= #{param1}
		<if test="param2 != 3">
			and app_state = #{param2}
		</if>
	</select>
	
	<!-- 리스트 -->
	<select id="meetAppsCall" resultType="myMeetApp">
		SELECT a.app_num, m.mem_id as app_id, m.mem_name as app_name, m.mem_phone as app_phone, m.mem_birth as app_birth,
		(select avg(grd_score) from grade g where g.grd_targetId=a.mem_id and g.grd_targetType=0) as grd_avg ,a.app_state
		FROM applicant a LEFT OUTER JOIN members m ON a.mem_id = m.mem_id
		WHERE a.meet_num=#{param3} AND a.app_state != 2
		<if test="param4 !=3">
			AND a.app_state=#{param4}
		</if>
		ORDER by a.app_state asc, a.app_num DESC
		LIMIT #{param1} OFFSET #{param2}
	</select>
	
	<!-- 신청자인원수 -->
	<select id="prsCount" resultType="int">
		select count(app_num) from applicant a1 where a1.meet_num=#{param1}
		union all
		select count(app_num) from applicant a2 where a2.meet_num=#{param1} and a2.app_state=1
		union all
		select count(app_num) from applicant a3 where a3.meet_num=#{param1} and a3.app_state=0;
	</select>
	
	

	<select id="grdAvg" resultType="String">
		select AVG(g.grd_score) from grade g where g.grd_targetId = #{param1} and grd_targetType=1
	</select>
	
	<update id="makeDel" parameterType="hashmap">
		UPDATE meeting SET meet_state=2 WHERE meet_num = #{param1}
	</update>
	
	<select id="ptReturnId" resultType="String">
		select mem_id from applicant where meet_num = #{param1} and app_state = 1
	</select>
	
	<select id="ptReturnCount" resultType="int">
		select meet_point from meeting where meet_num = #{param1}
	</select>

</mapper>